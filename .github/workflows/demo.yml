name: Local Deploy via Self-Hosted Runner (no setup-dotnet)

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

concurrency:
  group: local-deploy
  cancel-in-progress: true

defaults:
  run:
    shell: powershell   # use Windows PowerShell on the runner

env:
  DOTNET_EXE: C:\Program Files\dotnet\dotnet.exe
  TARGET_DIR: D:\Deploy\HelloVandit
  PORT: "5000"

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: dotnet --info
        run: |
          & "${{ env.DOTNET_EXE }}" --info

      - name: Publish (.NET)
        working-directory: ./src/HelloVandit
        run: |
          & "${{ env.DOTNET_EXE }}" restore
          & "${{ env.DOTNET_EXE }}" publish -c Release -o ../../publish

      - name: Mirror to TARGET_DIR
        run: |
          $buildDir = (Resolve-Path './publish').Path
          $target   = "${{ env.TARGET_DIR }}"
          if (-not (Test-Path $target)) { New-Item -ItemType Directory -Path $target | Out-Null }
          robocopy $buildDir $target /MIR /NFL /NDL /NJH /NJS /NP | Out-Null
          if ($LASTEXITCODE -gt 1) { throw "robocopy failed with exit code $LASTEXITCODE" }

      - name: Restart app (kill port & start new)
        run: |
          $port = [int]"${{ env.PORT }}"
          $c = Get-NetTCPConnection -LocalPort $port -ErrorAction SilentlyContinue | Where-Object State -eq 'Listen' | Select-Object -First 1
          if ($c) { Stop-Process -Id $c.OwningProcess -Force }
          Start-Sleep -Seconds 1

          $dll = Join-Path "${{ env.TARGET_DIR }}" "HelloVandit.dll"
          Start-Process -FilePath "${{ env.DOTNET_EXE }}" -ArgumentList @($dll,'--urls',"http://0.0.0.0:$port") -WindowStyle Hidden

          Start-Sleep -Seconds 2
          $r = Invoke-WebRequest -Uri "http://127.0.0.1:$port/" -UseBasicParsing -TimeoutSec 5
          if ($r.StatusCode -ne 200) { throw "Health check failed: $($r.StatusCode)" }
